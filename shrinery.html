<html lang="en">
    <head>
        <title>dSeHpRaIrNtE</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>

           

            #container
             	{	position: absolute;
             		width: 100%;
					 height: 100%;
   					
             	}
         
			.activate
			{		
				position: absolute;
				
			 	cursor:pointer;
   			   border:none;
    		  width:100%;
   			 height:100%;
   			/* background-color:rgba(0, 0, 0, 0);*/
   			background: transparent;
   			
			}
			.activate img{
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width:100px;
				height: 100px;

			}
			.infoPanel {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				
				width:200px;
				height:200px;
				text-align: center;
				color: white;
			
				visibility: hidden;
				background-color: black;

			}
			.infoPanel div {
				position: absolute;
				top: 50%;
				left: 0;
				transform: translateY(-50%);
			  	text-align: center;
			}
			.loadingBar{
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width:60px;
				height: 5px;
				background: white;
				//transition: width 0.1s;
				//-webkit-transition: width 0.1s;
			}


			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
				overflow: hidden;
				background: black;
				position: relative;
			}
			.shrines {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
			}
			.gui {
				position: absolute;
				bottom: 20px;
				left: 20px;
				right: 20px;
				text-align: center;
				visibility: hidden;
				
			}
			.gui ul {
				border: 1px white solid;
				display: inline-block;
				list-style: none;
				margin: 0;
				padding: 0;
			}
			.gui li {
				display: inline-block;
				border-right: 1px #fff solid;
			}
			.gui li:last-child {
				border: none;
			}
			.gui button {
				display: inline-block;
				text-align: center;
				border: 0;
				width: 40px;
				height: 40px;
				overflow: hidden;
				cursor: pointer;
			}

			button.quality {
				background: #666;
				background: transparent;
				background-image: url(img/icQual.svg);
				background-repeat: no-repeat;
				background-size: 16px 16px;
				background-position: center; 
			}
			button.quality.hi {
				background: red;
				background: transparent;
				background-image: url(img/icQual.svg);
				background-repeat: no-repeat;
				background-size: 16px 16px;
				background-position: center; 

			}
			button.sound {
				background: transparent;
				background-image: url(img/icMute.svg);
				background-repeat: no-repeat;
				background-size: 16px 16px;
				background-position: center; 

			}
			button.sound.muted {
				background: transparent;
				background-image: url(img/icMuted.svg);
				background-repeat: no-repeat;
				background-size: 16px 16px;
				background-position: center; 
			}
			button.info {
				background: transparent;
				background-image: url(img/icAbout.svg);
				background-repeat: no-repeat;
				background-size: 16px 16px;
				background-position: center; 

			}
			button.sound:hover, button.quality:hover{
				background: blue;
			}

			button span.active {
				display: none;				
			}
			button.active span.active {
				display: block;
			}
			button.active span.default {
				display: none;
			}			
        </style>
    </head>
    <body>
    <script type="text/javascript">
    function butQualityToggle()
	  { toggleQuality();
	  	if (ENABLESHADOWS) 	document.getElementById("butQuality").className = "quality hi";
	  	else document.getElementById("butQuality").className = "quality";
	  	console.log("ya"+document.getElementById("butQuality"));
	  }
	 function butSoundToggle()
	  { toggleSound();
	  	if (MUTED) 	document.getElementById("butSound").className = "sound muted";
	  	else document.getElementById("butSound").className = "sound";
	 // 	console.log("ya"+document.getElementById("butSound"));
	  }

	 function butActivate()
	 {
	 	freezeSimulation(false);
	 	document.getElementById("gui").style.visibility='visible';
	 }
    </script>

    <div class="shrines">
        <div id="container" class="container"></div>
        <button class="activate" onclick="butActivate();this.style.visibility='hidden';">
        <div id="loadingBar" class="loadingBar"></div>
        	<img src="img/shrineCircular.svg" />
        	
		</button>
		<div id="infoPanel" class="infoPanel"><div>Shrine by <a href="http://depart.at">depart</a><br><br>there will always be beginnings</div></div>
		<div class="gui" id="gui">
			
			<ul>
				<li>
					<button id="butQuality" type="button" class="quality" onClick="butQualityToggle();">
						<span class="default"></span>
						<span class="active"></span>
					</button>
				</li><!--
				--><li>
					<button id="butSound" type="button" class="sound" onClick="butSoundToggle();">
						<span class="default"></span>
						<span class="active"></span>						
					</button>
				</li><!--
				--><li>
					<button id="butInfo" type="button" class="info" onClick="loadLocation();">
						<span class="default"></span>
					</button>
				</li>
			</ul>
</div>
	</div>   



    	<script type="text/javascript" src="lib/three/build/three.min.js"></script>  
    	<script type="text/javascript" src="lib/three/examples/js/controls/OrbitControls.js"></script>
    	<script type="text/javascript" src="lib/three/examples/js/libs/stats.min.js"></script>
	 	<script type="text/javascript" src="lib/physi/physi.js"></script>
	    <script src="lib/three/examples/js/Detector.js"></script>
		<script src="objectCreators.js"></script>

        <script type="text/javascript">
        'use strict';
	
        Physijs.scripts.worker = 'lib/physi/physijs_worker.js';
        Physijs.scripts.ammo = 'examples/js/ammo.js'; // doesnt work with new ammo.js from githug (collisions) // path is relative to the worker
		
		// Detects webgl
		if ( ! Detector.webgl ) {
		    Detector.addGetWebGLMessage();
		    document.getElementById( 'container' ).innerHTML = "";
		}

		
		var SIMULATE=false;   //physics simulation running?
		var ACTIVATED=false; // initially the scene is paused and needs to be clicked once to start
        var WORLDSCALE=40; //40  -- scale the whole world for slow-motion feeling
        var ANTIALIAS=true;		//antialiasing setting for renderer >> changed in initWorld
        var ENABLESHADOWS=false;	//initial state of shadows, can be changed at runtime
        var COLLAPSETIME=40;		//time to restart the scence in seconds
        var MUTED=false;		// sound muted, changed at runtime
        var DEBUG=true;		//display stats


        var countdown=COLLAPSETIME;	// the countdown to the next restart
        
        var frm=0;					// frame counter, for rendering the physics engine only every 2nd frame

       // var timestep=1/1000;		// not really used anymore
        
		// Graphics variables
		var container, stats, physics_stats;
		var camera, controls, scene_physi, renderer,skybox;
		var textureLoader;
		var tGlobalLightInt=1; //target light intensity, for animating light intensity
		var cGlobalLightInt=1;

		var clock = new THREE.Clock();
		var resetting=false;
		var resetInterval;
		// Physics variables    // Physi.js
		var physiBoxMaterial; // the standard material for most of the physical bodies
	    var physiBodies = []; // all the physijs obj in the scene for the simulation
	    var layoutTables=[];
	    var removeableBodies=[];
		
        var physi_ground;
		var light1,light2,light3;
		var light1PulseAng=0,light2PulseAng=0,light3PulseAng=0;
		var screenLight;
		
		var ground_material;
		var lineMaterial;
		var skyBoxMaterial;
		var cubeMaterial;
		var cubeMaterialDull;
 
        var screenObj;

        // TEXTURES - all textures are global for easier load management
        var tex_stoneStaple;
        var tex_reflectionCube;
        var tex_grid;
        

        // for rendering the texture into the screen
        var canvas, context, tex_canvas;

        // SOUND ------ 
        
        var bgloop, audioBgloop, freeze, audioFreezeloop, rumba, audioRumba, rainrumba, audioRainrumba;
        var snd_osc1_1,snd_osc2_1,snd_osc3_1, audioOsc1_1,audioOsc2_1,audioOsc3_1 , listener;
		var snd_osc1_2,snd_osc2_2,snd_osc3_2, audioOsc1_2,audioOsc2_2,audioOsc3_2;
		var snd_Frosc1_1,snd_Frosc2_1,snd_Frosc3_1, audioFrOsc1_1,audioFrOsc2_1,audioFrOsc3_1;
		var snd_Frosc1_2,snd_Frosc2_2,snd_Frosc3_2, audioFrOsc1_2,audioFrOsc2_2,audioFrOsc3_2;
		var audioBassic1,audioBassic2,audioBassic3,audioKling;
		var audioBassic1_1,audioBassic2_1,audioBassic3_1;
		var snd_Bassic1,snd_Bassic2,snd_Bassic3,snd_Kling;
		var snd_Bassic1_1,snd_Bassic2_1,snd_Bassic3_1;


        // 10x10 grid to keep track of height levels 
        var layoutHeights=[
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
        ];
		

function reset()
    {layoutHeights=[
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0],];
      //     
      for (var i=0;i<removeableBodies.length;i++)
      {
      	scene_physi.remove(removeableBodies[i]);
      	renderer.dispose( physiBodies[i] );
      }
      
      removeableBodies = [];

      countdown=COLLAPSETIME;
	  light1PulseAng=0;
	  light2PulseAng=0;
	  light3PulseAng=0;

      createRemoveableBodies();
      setTimeout(function() {resetInterval=setInterval(afterResetTO,25)}, 200);
      setTimeout(function() {SIMULATE=true}, 5000);

    }


function initSound()
  {	
	camera.add( listener );
	audioFreezeloop.setVolume(0);
	audioBgloop.setVolume(0);
	audioRainrumba.setVolume(0);
	audioRumba.setVolume(0);
	if (audioBassic1.isPlaying) audioBassic1.stop();
	if (audioBassic2.isPlaying) audioBassic2.stop();
	if (audioBassic3.isPlaying) audioBassic3.stop();

	if (audioBassic1_1.isPlaying) audioBassic1_1.stop();
	if (audioBassic2_1.isPlaying) audioBassic2_1.stop();
	if (audioBassic3_1.isPlaying) audioBassic3_1.stop();
		

	audioFrOsc1_1.setVolume(0);
	audioFrOsc2_1.setVolume(0);
	audioFrOsc3_1.setVolume(0);

	audioFrOsc1_2.setVolume(0);
	audioFrOsc2_2.setVolume(0);
	audioFrOsc3_2.setVolume(0);

	audioOsc1_1.setVolume(0);
	audioOsc2_1.setVolume(0);
	audioOsc3_1.setVolume(0);

	audioOsc1_2.setVolume(0);
	audioOsc2_2.setVolume(0);
	audioOsc3_2.setVolume(0);

	if (audioOsc1_1.isPlaying) audioOsc1_1.stop();
	if (audioOsc1_2.isPlaying) audioOsc1_2.stop();
	if (audioOsc2_1.isPlaying) audioOsc2_1.stop();
	if (audioOsc2_2.isPlaying) audioOsc2_2.stop();
	if (audioOsc3_1.isPlaying) audioOsc3_1.stop();
	if (audioOsc3_2.isPlaying) audioOsc3_2.stop();
	if (audioOsc1_1.isPlaying) audioFrOsc1_1.stop();
	if (audioOsc1_2.isPlaying) audioFrOsc1_2.stop();
	if (audioOsc2_1.isPlaying) audioFrOsc2_1.stop();
	if (audioOsc2_2.isPlaying) audioFrOsc2_2.stop();
	if (audioOsc3_1.isPlaying) audioFrOsc3_1.stop();
	if (audioOsc3_2.isPlaying) audioFrOsc3_2.stop();

	
	 
  }


		
		function initCamera()
		 { // CAMERA
			camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.2*WORLDSCALE, 180*WORLDSCALE );
			camera.position.x = 10*WORLDSCALE;
			camera.position.y = 10*WORLDSCALE;
			camera.position.z =  18*WORLDSCALE;
			//camera.lookAt(0,0,0);
			controls = new THREE.OrbitControls( camera );
			controls.autoRotate = true;
			controls.autoRotateSpeed = -0.1;
			controls.userPan=false;
			
			controls.userPanSpeed = 0.001;
			controls.enableDamping = true;
			controls.dampingFactor = 0.06;
			controls.maxPolarAngle = 1.7; // stay above ground 
			controls.target.y = 6*WORLDSCALE;
			controls.minDistance = 10*WORLDSCALE;
			controls.maxDistance = 25*WORLDSCALE;
			controls.momentumScalingFactor=0.00001;
			scene_physi.add(camera); // only necessary because the skybox is CHILD of the cam

		 }

		 function initRenderer()
		 {	
			 var pixelratio = window.devicePixelRatio || 1;
			 if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) 
				{
 					ENABLESHADOWS=false;
 					ANTIALIAS=false;
				}
			if (pixelratio>1) ANTIALIAS=false;
			renderer = new THREE.WebGLRenderer({antialias:ANTIALIAS});
			renderer.setClearColor( 0x000);
			//renderer.gammaInput = true;
			//renderer.gammaOutput = true;
			
			console.log("ratio="+pixelratio);
			renderer.setPixelRatio(pixelratio);
			onWindowResize();  // set rendersize, 


			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type=THREE.PCFSoftShadowMap; //THREE.BasicShadowMap, THREE.PCFShadowMap (default), THREE.PCFSoftShadowMap
			renderer.shadowMapSoft=true;
		 }

		 function initLights()
		 {
			var ambientLight = new THREE.AmbientLight( 0x111111 );
			//scene_physi.add( ambientLight );
			

				// LIGHTS
				var mapsize=256;
	            var d = 10*WORLDSCALE;
	            var intensity=0;
	            var dist=30*WORLDSCALE;
	            var decay=8;
            	
				var sphere = new THREE.SphereGeometry( 0.1*WORLDSCALE, 12, 8 );
				

				var col=0xffbfa3;//ffd0bc
				light1 = new THREE.PointLight( col, intensity, dist,decay ); //color, intensity, distance, decay (default is 1, 2 is phyical correct)
				var obj1= new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: col, transparent:true } ) );
				light1.add(obj1);
				light1.obj=obj1;
				light1.castShadow=ENABLESHADOWS;
				light1.shadow.mapSize.x = mapsize; light1.shadow.mapSize.y = mapsize;
                light1.shadow.camera.left = -d; light1.shadow.camera.right = d;	light1.shadow.camera.top = d;	light1.shadow.camera.bottom = -d;
    		    light1.shadow.camera.near = 2;  light1.shadow.camera.far = 200*WORLDSCALE;
				scene_physi.add( light1 );

				col=0xffe8bc;
				light2 = new THREE.PointLight( col, intensity, dist,decay );
				var obj2= new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: col, transparent:true } ) );
				light2.add(obj2);
				light2.obj=obj2;
				light2.castShadow=ENABLESHADOWS;
				light2.shadow.mapSize.x = mapsize; light2.shadow.mapSize.y = mapsize;
                light2.shadow.camera.left = -d; light2.shadow.camera.right = d;	light2.shadow.camera.top = d;	light2.shadow.camera.bottom = -d;
    		    light2.shadow.camera.near = 2;  light2.shadow.camera.far = 100*WORLDSCALE;
				scene_physi.add( light2 );

				col=0x7b8fff2;//ffbc5e;
				light3 = new THREE.PointLight( col,intensity,dist,decay );
				var obj3= new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: col, transparent:true } ) );
				light3.add(obj3);
				light3.obj=obj3;
				light3.castShadow=ENABLESHADOWS;
				light3.shadow.mapSize.x = mapsize; light3.shadow.mapSize.y = mapsize;
                light3.shadow.camera.left = -d; light3.shadow.camera.right = d;	light3.shadow.camera.top = d;	light3.shadow.camera.bottom = -d;
    		    light3.shadow.camera.near = 2;  light3.shadow.camera.far = 100*WORLDSCALE;
				scene_physi.add( light3 );
				
		}

		function manageLoading()
			{	var loader = new THREE.TextureLoader();
				//tex_stoneStaple = 	loader.load( "img/staple.jpg" );
				
				

				tex_grid =			loader.load( "img/grid.png" );

				var skypath = "img/sky54/";
				var skyformat = '.jpg';
				var skyurls = [
						skypath + 'px' + skyformat, skypath + 'nx' + skyformat,
						skypath + 'py' + skyformat, skypath + 'ny' + skyformat,
						skypath + 'pz' + skyformat, skypath + 'nz' + skyformat
					];
				tex_reflectionCube = new THREE.CubeTextureLoader().load( skyurls );

				// AUDIO INIT -----------------------------------------------------------------------------------

				listener = new THREE.AudioListener();
				audioBgloop = new THREE.Audio( listener );
				bgloop = new THREE.AudioLoader().load( 'snd/shrine_back_loop.wav', function( buffer ) {
					audioBgloop.setBuffer( buffer );
					audioBgloop.setLoop(true);
					audioBgloop.setVolume(0);
					
					audioBgloop.play();
				});

						audioFreezeloop = new THREE.Audio( listener );
				freeze = new THREE.AudioLoader().load( 'snd/shrine_frozen_loop.mp3', function( buffer ) {
					audioFreezeloop.setBuffer( buffer );
					audioFreezeloop.setLoop(true);
					audioFreezeloop.setVolume(0);
					
					audioFreezeloop.play();
				});
			
				audioRumba = new THREE.Audio( listener );
				rumba = new THREE.AudioLoader().load( 'snd/rumba.mp3', function( buffer ) {
					audioRumba.setBuffer( buffer );
					audioRumba.setLoop(true);
					audioRumba.setVolume(0);
			
					audioRumba.play();
				});

				audioRainrumba = new THREE.Audio( listener );
				rainrumba = new THREE.AudioLoader().load( 'snd/rain_rumba.mp3', function( buffer ) {
					audioRainrumba.setBuffer( buffer );
					audioRainrumba.setLoop(true);
					audioRainrumba.setVolume(0);
					
					audioRainrumba.play();
				});

				audioOsc1_1 = new THREE.Audio( listener );
				snd_osc1_1 = new THREE.AudioLoader().load( 'snd/sph_3_1.wav', function( buffer ) {
					audioOsc1_1.setBuffer( buffer );
					audioOsc1_1.setLoop(true);
					audioOsc1_1.setVolume(0);
					
					audioOsc1_1.play();
				});
				//listener = new THREE.AudioListener();
				audioOsc2_1 = new THREE.Audio( listener );
				snd_osc2_1 = new THREE.AudioLoader().load( 'snd/sph_2_1.wav', function( buffer ) {
					audioOsc2_1.setBuffer( buffer );
					audioOsc2_1.setLoop(true);
					audioOsc2_1.setVolume(0);

			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioOsc2_1.play();
				});
				
				//listener = new THREE.AudioListener();
				audioOsc3_1 = new THREE.Audio( listener );
				snd_osc3_1 = new THREE.AudioLoader().load( 'snd/sph_1_1.wav', function( buffer ) {
					audioOsc3_1.setBuffer( buffer );
					audioOsc3_1.setLoop(true);
					audioOsc3_1.setVolume(0);
			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioOsc3_1.play();
				});

				audioOsc1_2 = new THREE.Audio( listener );
				snd_osc1_2 = new THREE.AudioLoader().load( 'snd/sph_3_2.wav', function( buffer ) {
					audioOsc1_2.setBuffer( buffer );
					audioOsc1_2.setLoop(true);
					audioOsc1_2.setVolume(0);
					
					audioOsc1_2.play();
				});
				//listener = new THREE.AudioListener();
				audioOsc2_2 = new THREE.Audio( listener );
				snd_osc2_2 = new THREE.AudioLoader().load( 'snd/sph_2_2.wav', function( buffer ) {
					audioOsc2_2.setBuffer( buffer );
					audioOsc2_2.setLoop(true);
					audioOsc2_2.setVolume(0);

			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioOsc2_2.play();
				});
				
				//listener = new THREE.AudioListener();
				audioOsc3_2 = new THREE.Audio( listener );
				snd_osc3_2 = new THREE.AudioLoader().load( 'snd/sph_1_2.wav', function( buffer ) {
					audioOsc3_2.setBuffer( buffer );
					audioOsc3_2.setLoop(true);
					audioOsc3_2.setVolume(0);
			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioOsc3_2.play();
				});

				audioFrOsc1_1 = new THREE.Audio( listener );
				snd_Frosc1_1 = new THREE.AudioLoader().load( 'snd/sph_fr_3_1.wav', function( buffer ) {
					audioFrOsc1_1.setBuffer( buffer );
					audioFrOsc1_1.setLoop(true);
					audioFrOsc1_1.setVolume(0);
					
					audioFrOsc1_1.play();
				});
				//listener = new THREE.AudioListener();
				audioFrOsc2_1 = new THREE.Audio( listener );
				snd_Frosc2_1 = new THREE.AudioLoader().load( 'snd/sph_fr_2_1.wav', function( buffer ) {
					audioFrOsc2_1.setBuffer( buffer );
					audioFrOsc2_1.setLoop(true);
					audioFrOsc2_1.setVolume(0);

			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioFrOsc2_1.play();
				});
				
				//listener = new THREE.AudioListener();
				audioFrOsc3_1 = new THREE.Audio( listener );
				snd_Frosc3_1 = new THREE.AudioLoader().load( 'snd/sph_fr_1_1.wav', function( buffer ) {
					audioFrOsc3_1.setBuffer( buffer );
					audioFrOsc3_1.setLoop(true);
					audioFrOsc3_1.setVolume(0);
			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioFrOsc3_1.play();
				});

				audioFrOsc1_2 = new THREE.Audio( listener );
				snd_Frosc1_2 = new THREE.AudioLoader().load( 'snd/sph_fr_3_2.wav', function( buffer ) {
					audioFrOsc1_2.setBuffer( buffer );
					audioFrOsc1_2.setLoop(true);
					audioFrOsc1_2.setVolume(0);
				
					audioFrOsc1_2.play();
				});
				//listener = new THREE.AudioListener();
				audioFrOsc2_2 = new THREE.Audio( listener );
				snd_Frosc2_2 = new THREE.AudioLoader().load( 'snd/sph_fr_2_2.wav', function( buffer ) {
					audioFrOsc2_2.setBuffer( buffer );
					audioFrOsc2_2.setLoop(true);
					audioFrOsc2_2.setVolume(0);

			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioFrOsc2_2.play();
				});
				
				//listener = new THREE.AudioListener();
				audioFrOsc3_2 = new THREE.Audio( listener );
				snd_Frosc3_2 = new THREE.AudioLoader().load( 'snd/sph_fr_1_2.wav', function( buffer ) {
					audioFrOsc3_2.setBuffer( buffer );
					audioFrOsc3_2.setLoop(true);
					audioFrOsc3_2.setVolume(0);
			//		audioOsc3.setRefDistanc(20*WORLDSCALE);
					audioFrOsc3_2.play();
				});
				

				//listener = new THREE.AudioListener();
				audioBassic1 = new THREE.Audio( listener );
				snd_Bassic1 = new THREE.AudioLoader().load( 'snd/bassic_1.mp3', function( buffer ) {
					audioBassic1.setBuffer( buffer );
					audioBassic1.setLoop(false);
					audioBassic1.setVolume(0);
					audioBassic1.play();
				});
				audioBassic2 = new THREE.Audio( listener );
				snd_Bassic2 = new THREE.AudioLoader().load( 'snd/bassic_2.mp3', function( buffer ) {
					audioBassic2.setBuffer( buffer );
					audioBassic2.setLoop(false);
					audioBassic2.setVolume(0);
					audioBassic2.play();
				});
				audioBassic3 = new THREE.Audio( listener );
				snd_Bassic3 = new THREE.AudioLoader().load( 'snd/bassic_3.mp3', function( buffer ) {
					audioBassic3.setBuffer( buffer );
					audioBassic3.setLoop(false);
					audioBassic3.setVolume(0);
					audioBassic3.play();
				});

				audioBassic1_1 = new THREE.Audio( listener );
				snd_Bassic1_1 = new THREE.AudioLoader().load( 'snd/bassic_4.mp3', function( buffer ) {
					audioBassic1_1.setBuffer( buffer );
					audioBassic1_1.setLoop(false);
					audioBassic1_1.setVolume(0);
					audioBassic1_1.play();
				});
				audioBassic2_1 = new THREE.Audio( listener );
				snd_Bassic2_1 = new THREE.AudioLoader().load( 'snd/bassic_5.mp3', function( buffer ) {
					audioBassic2_1.setBuffer( buffer );
					audioBassic2_1.setLoop(false);
					audioBassic2_1.setVolume(0);
					audioBassic2_1.play();
				});
				audioBassic3_1 = new THREE.Audio( listener );
				snd_Bassic3_1 = new THREE.AudioLoader().load( 'snd/bassic_6.mp3', function( buffer ) {
					audioBassic3_1.setBuffer( buffer );
					audioBassic3_1.setLoop(false);
					audioBassic3_1.setVolume(0);
					audioBassic3_1.play();
				});

				//listener = new THREE.AudioListener();
				audioKling = new THREE.Audio( listener );
				snd_Kling = new THREE.AudioLoader().load( 'snd/klingeling.mp3', function( buffer ) {
					audioKling.setBuffer( buffer );
					audioKling.setLoop(true);
					audioKling.setVolume(0);
					audioKling.play();
				});


				//---------------------------------------------------------------------------
				
				

				THREE.DefaultLoadingManager.onStart = function ( url, itemsLoaded, itemsTotal ) {

				console.log( 'Started loading file: ' + url + '.\nLoaded ' + itemsLoaded + ' of ' + itemsTotal + ' files.' );

				};

				THREE.DefaultLoadingManager.onLoad = function ( ) {

					console.log( 'Loading Complete!'); 
					setTimeout(initWorld,100);  // otherwise the sound loader produces an error (because the file seems to be not there yet)
					

				};


				THREE.DefaultLoadingManager.onProgress = function ( url, itemsLoaded, itemsTotal ) {

					console.log( 'Loading file: ' + url + '.\nLoaded ' + itemsLoaded + ' of ' + itemsTotal + ' files.' );
				//var el=document.getElementById("loadingBar");
				document.getElementById("loadingBar").style.width=(1-itemsLoaded/itemsTotal)*60;

				};

				THREE.DefaultLoadingManager.onError = function ( url ) {

					console.log( 'There was an error loading ' + url );

				}
				
			}


		// RESTARTING -----------------------------------------------

		function prepareReset()
			{//	SIMULATE=false;
				freezeSimulation(true);
				tGlobalLightInt=-0.5;
				resetting=true;
				clearInterval(resetInterval);
				resetInterval=setInterval(prepareResetTO,25);
				

			}
		function prepareResetTO()
			{	//scene_physi.background.transparent=true;
				//scene_physi.background.opacity=0
				//skybox.material.opacity=0;
				skyBoxMaterial.uniforms.opacity= { type: "f", value: light1.intensity  };
				;
				if (light1.intensity<=0) 
					{clearInterval(resetInterval)
					 reset();
					}
			}
		function afterResetTO()
		   {skyBoxMaterial.uniforms.opacity= { type: "f", value: light1.intensity  };
		    freezeSimulation(false);
		  
		   	tGlobalLightInt=1;
		   	if (light1.intensity>=0.9) 
					{clearInterval(resetInterval)
					 skyBoxMaterial.uniforms.opacity= { type: "f", value: 1  };
					 resetting=false;
					}
		   	

		   }



		function updateTexCanvas()
		  {	
		  	// canvas w 512 >> use only 512*9/16 
		  	var asp=9/16;
		  //	context.font = '30pt Arial';
		    context.fillStyle = 'white';
		  //  context.fillRect(0, 0, canvas.width*asp, canvas.height);
		 //   context.fillStyle = 'black';
		  //  context.fillRect(10, 10, canvas.width*asp - 20, (canvas.height - 20)*( 1 -Math.min(1,countdown/COLLAPSETIME))  );
		    var img = new Image();
			
			img.onload = function() {
    			context.drawImage(img, 0, 0, canvas.width*asp , canvas.height);
				}
			img.src = 'img/staple.jpg';
		  //  context.fillStyle = 'black';
		 //   context.textAlign = "center";
		  //  context.textBaseline = "middle";
		  //  context.fillText( Math.round(countdown), canvas.width*asp / 2, canvas.height / 2);

		  	var h= Math.min(1,countdown/COLLAPSETIME)*canvas.height;
		    context.fillRect(0,canvas.height-h, canvas.width*asp - 20, h)  ;
		    tex_canvas.repeat.set(asp,1);
		    tex_canvas.needsUpdate = true;
		  }



		// MAIN INIT  
		function initWorld() {
			
			container = document.getElementById( 'container' );
			canvas=document.createElement("canvas");
			canvas.width=512;
			canvas.height=512;
			context=canvas.getContext("2d");
		
   			tex_canvas=new THREE.Texture(canvas, { minFilter: THREE.NearestFilter, magFilter: THREE.NearestFilter});
   			tex_canvas.repeatS
   			tex_canvas.needsUpdate=true;
   		//	tex_canvas.minFilter=THREE.NearestMipMapLinearFilter;
   			lineMaterial=new THREE.LineBasicMaterial({color:0xffffff});//( color, linewidth, linecap, linejoin, vertexColors );

			if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) 
				{
 					ENABLESHADOWS=false;
 					ANTIALIAS=false;
				}

				scene_physi =new Physijs.Scene({reportsize:200, fixedTimeStep: 1/90 }); //{ reportsize: 50, fixedTimeStep: 1/60 }
			
           	initCamera();
           	initRenderer();
           	initSound();
            //SCENE Physi
            
            scene_physi.setGravity(new THREE.Vector3( 0, -10, 0 ));
            scene_physi.addEventListener(
                'update',
                function() {
					//var deltaTime = clock.getDelta();
                    
						
					//	if (SIMULATE) scene_physi.simulate(timestep, 0.5 ); //timestep, maxsteps
                    if (DEBUG) physics_stats.update();
				   
                }
            );

            
            initLights();

            /*
			// REFLECTION -------------------------------------------------------
			tex_reflectionCube.format = THREE.RGBFormat;
			tex_reflectionCube.minFilter = THREE.LinearFilter;
				
			cubeMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff, envMap: tex_reflectionCube, combine: THREE.MixOperation, reflectivity: 0.6 } );
			cubeMaterialDull= new THREE.MeshPhongMaterial( { color: 0xffffff, envMap: tex_reflectionCube,  combine: THREE.MixOperation,reflectivity: 0.1 } );
			*/

			// skybox-------------------------------------------------------
			var skyboxShader = THREE.ShaderLib['cube'];
			skyBoxMaterial = new THREE.ShaderMaterial( {
			    fragmentShader: skyboxShader.fragmentShader,
			    vertexShader: skyboxShader.vertexShader,
			    uniforms: {
			        "tCube": { type: "t", value: tex_reflectionCube },
			        "tFlip": { type: "f", value: -1 },
			        "opacity": {value:1.0 }
			    },
			    
			    depthWrite: true,
			    transparent:true,
			    side: THREE.BackSide
			   
			});
		
		
			skybox = new THREE.Mesh(
			    new THREE.CubeGeometry(60*WORLDSCALE,60*WORLDSCALE,60*WORLDSCALE),
			    skyBoxMaterial
			);

			camera.add(skybox);


			// create ground plane ------------------------------------------------------
			
			tex_grid.wrapS = THREE.RepeatWrapping;
			tex_grid.wrapT = THREE.RepeatWrapping;
			tex_grid.repeat.set( 40, 40 );

            ground_material = Physijs.createMaterial(
                new THREE.MeshPhongMaterial({color:0xffffff,map:tex_grid}),
                .8, // high friction
                .3  // low restitution
                );
		
            physi_ground = new Physijs.BoxMesh(
                new THREE.BoxBufferGeometry(50*WORLDSCALE, 1, 50*WORLDSCALE),
                ground_material,
                0 // mass
                );
           
            physi_ground.position.set(0, -0.5,0);// y=-0.55
            physi_ground.receiveShadow = false;
            scene_physi.add( physi_ground );
			
			//----------------
			createStaticBodies();
			createRemoveableBodies();


			window.addEventListener( 'resize', onWindowResize, false );
            requestAnimationFrame( render );
	        //scene_physi.simulate();
		    
		    container.innerHTML = "";
			container.appendChild( renderer.domElement );
            
            // STATS
            if (DEBUG)
            {
           

			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			container.appendChild( stats.domElement );

			physics_stats = new Stats();
			physics_stats.domElement.style.position = 'absolute';
			physics_stats.domElement.style.top = '50px';
			physics_stats.domElement.style.zIndex = 100;
			container.appendChild( physics_stats.domElement );
			}

			initInput();

			
			
		}


/// PHYSICALS 
	

	


    

	
	function updateLayoutHeights(x,y ,w,h, value) // all integers 0...9
        {   
            for (var ix=x;ix<w+x;ix++)
                {
                    for (var iy=y;iy<h+y;iy++)
                        {
                         layoutHeights[ix][iy]= value;
                        // console.log("height="+ix+"/"+iy+" >"+layoutHeights[ix][iy])
                        }
                }
            
        }
     function checkLayoutHeightViolation(x,y ,w,h, value) // all integers 0...9
        {   var violation=false;
        	
            for (var ix=x;ix<w+x;ix++)
                {
                    for (var iy=y;iy<h+y;iy++)
                        {
                         if (layoutHeights[ix][iy]>value) violation=true;
                         //console.log("height="+ix+"/"+iy+" >"+layoutHeights[ix][iy])
                        }
                }

         return violation   
        }

   function checkLayoutMaxHeight(x,y ,w,h, value) // all integers 0...9
        {   var violation=false;
        	var maxValue=0;
            for (var ix=x;ix<w+x;ix++)
                {
                    for (var iy=y;iy<h+y;iy++)
                        {maxValue=Math.max(layoutHeights[ix][iy],maxValue)
                         if (layoutHeights[ix][iy]>value) violation=true;
                        // console.log("height="+ix+"/"+iy+" >"+layoutHeights[ix][iy])
                        }
                }

         return maxValue   
        }

	function ready()
		{//console.log("ready");
		}


  
	
	function createStaticBodies() 
		{	
			physiBoxMaterial= Physijs.createMaterial(
					new THREE.MeshPhongMaterial(), //cubeMaterialDull,//
					.6, // medium friction
					.3 // low restitution
				);

			
            createPlinth();
            createScreen(9/4,16/4,6);
            //	 createAura();
		}
	function createRemoveableBodies()
	    {
	    	for (var i=3;i<30;i++)
			 {	 var x=Math.round(Math.random()*9);
				 var y=Math.round(Math.random()*9);
				 var w=Math.min(4,Math.max(1,Math.round(Math.random()*(10-x))));
				 var h=Math.min(4,Math.max(1,Math.round(Math.random()*(10-y))));
				 createLayoutTable(x,y, w,h, i*0.6);
			 }
	    }
		
		function initInput() {

		    window.addEventListener( 'keydown', function( event ) {

			    switch ( event.keyCode ) {
				    // Q
				    case 81:
				    //resetLayoutTables();
 					toogleSound();
					//reset();
				    break;

				    case 77:
				    	toggleShadows();
				    break;

				    // A
				    case 65:
						if (tGlobalLightInt==1) tGlobalLightInt=-1;
						else tGlobalLightInt=1;
						cubeMaterial.color.setHex(0x000);


					break;

					case 83: //S
					  SIMULATE=!SIMULATE;
					  if (SIMULATE) scene_physi.onSimulationResume();
					  	//console.log("dad"+SIMULATE);
				    break;

				    case 68://D
				     // timestep=1/5.0;
					
				    break;
			    }

		    }, false );

		    window.addEventListener( 'keyup', function( event ) {

			  

		    }, false );

		    document.getElementById("container").addEventListener( 'mousedown', function( event ) {
		    	if(!resetting) freezeSimulation(true);
		    }, false );
		    document.getElementById("container").addEventListener( 'mouseup', function( event ) {
		    	if(!resetting) freezeSimulation(false);
		    }, false );

		}

		function onWindowResize() {
			console.log("resize");
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

		//	renderer.setSize( window.innerWidth, window.innerHeight );
			// Resize renderTargets
				//ssaoPass.uniforms[ 'size' ].value.set( width, height );
				var el=document.getElementById("container");
				var width=el.offsetWidth;//window.innerWidth;
				var height=el.offsetHeight;//window.innerHeight;
				var pixelRatio = renderer.getPixelRatio();
				var newWidth  = Math.floor( width / pixelRatio ) || 1;
				var newHeight = Math.floor( height / pixelRatio ) || 1;
				//depthRenderTarget.setSize( newWidth, newHeight );
				//effectComposer.setSize( newWidth, newHeight );
				renderer.setSize( width, height);


		}

		function kick()
		 {	//console.log("kick");
				for ( var i = 0, il = physiBodies.length; i < il; i++ ) 
						{
						var pobj = physiBodies[i];
					//
					//	obj.applyCentralImpulse(new THREE.Vector3(1000,-1000,0));
						pobj.applyCentralImpulse(new THREE.Vector3(10000,1000,0));
					
						}
			 
		 }

//=================================================================================================================================7=============

	function render() 
        {	var delta=clock.getDelta();
          // console.log(physiBodies.length);
         
          frm++;
          
            if (SIMULATE && frm%1==0) 
            	{scene_physi.simulate(delta, 5 ); //timestep, maxsteps
           		 countdown-=delta;
           		}
            if (countdown<=0 && !resetting) 
            	{prepareReset();
            	 //console.log("prepare reset");
            	}
           	
        	controls.update(delta );
			animateLights(delta);
			updateTexCanvas();
			/*
            skybox.position.x=camera.position.x;
		    skybox.position.y=camera.position.y;
		    skybox.position.z=camera.position.z;
		    */
			if (DEBUG) stats.update();
/*
			for (var i=0;i<layoutTables.length;i++)
			{
				
				var v=new THREE.Vector3(0,160,0);
				//v.copy(layoutTables[i].top.position);
				//v.sub(layoutTables[i].leg1.position);
				//scene_physi.update();
				
				var nv=layoutTables[i].leg1.worldToLocal(v);
				layoutTables[i].leg1._geomLine.dynamic = true;
				layoutTables[i].leg1._geomLine.vertices[1].x=nv.x;
				layoutTables[i].leg1._geomLine.vertices[1].y=nv.y;
				layoutTables[i].leg1._geomLine.vertices[1].z=nv.z;
				//layoutTables[i].leg1._geomLine.vertices[0]=new THREE.Vector3(0,0,0);
				//layoutTables[i].leg1._geomLine.__dirtyVertices = true;
				layoutTables[i].leg1._geomLine.verticesNeedUpdate = true;
				if (i==1) console.log(layoutTables[i].leg1.worldToLocal(v));
			//	layoutTables[i].leg1._geomLine.vertices[1].y=layoutTables[i].leg2.position.y-layoutTables[i].leg1.position.y;
			//		layoutTables[i].leg1._geomLine.vertices[1].z=layoutTables[i].leg2.position.z-layoutTables[i].leg1.position.z;

			}
			*/
            renderer.render( scene_physi, camera );
            requestAnimationFrame( render );
			
		}

//==============================================================================================================================================
   
    function toggleQuality()
      {
		ENABLESHADOWS=!ENABLESHADOWS;
		light1.castShadow=false;
		light2.castShadow=ENABLESHADOWS;
      	light3.castShadow=ENABLESHADOWS;//ENABLESHADOWS;
      	screenLight.castShadow=false;
      	// not possible at runtim
      	//ANTIALIAS=ENABLESHADOWS;
      	//scene_physi.antialias=ENABLESHADOWS;
      }

   function toggleSound()
     {MUTED=!MUTED;
     	if (MUTED)
     	{
     		audioFreezeloop.setVolume(0);
			audioBgloop.setVolume(0);
			audioRainrumba.setVolume(0);
			audioRumba.setVolume(0);

			audioFrOsc1_1.setVolume(0);
			audioFrOsc2_1.setVolume(0);
			audioFrOsc3_1.setVolume(0);

			audioFrOsc1_2.setVolume(0);
			audioFrOsc2_2.setVolume(0);
			audioFrOsc3_2.setVolume(0);

			audioOsc1_1.setVolume(0);
			audioOsc2_1.setVolume(0);
			audioOsc3_1.setVolume(0);

			audioOsc1_2.setVolume(0);
			audioOsc2_2.setVolume(0);
			audioOsc3_2.setVolume(0);

			audioBassic1.setVolume(0);
			audioKling.setVolume(0);
     	}
     else 
     	freezeSimulation(!SIMULATE);

     }

	function animateLights(delta)
        {   
            var t=clock.elapsedTime;
            
            var r=9*WORLDSCALE;
            var yos=6*WORLDSCALE;
            var yr=5*WORLDSCALE;

            var os=Math.PI*2/3;
           // light1.intensity=light2.intensity=light3.intensity=0.6;

            var l1y=Math.sin( t * 0.5  );
            var l2y=Math.sin( t * 0.5 +os );
            var l3y=Math.sin( t * 0.5 +2*os );

            if (SIMULATE)
	            {
	            light1PulseAng+=10*delta*(l1y+1)/2+0.1;
	            light2PulseAng+=10*delta*(l2y+1)/2+0.1;
	            light3PulseAng+=10*delta*(l3y+1)/2+0.1;
	            }
            
            var l1Int= (((Math.sin(light1PulseAng)+1)/2)+0.1 ) ;

            
            var l2Int=(((Math.sin(light2PulseAng)+1)/2+0.1));

            
            var l3Int=(((Math.sin(light3PulseAng)+1)/2+0.1));



            light1.position.x = Math.sin( t * 0.3  ) * r;
            light1.position.y = l1y* yr+yos;//Math.cos( t * 0.05 ) * r;
            light1.position.z = Math.cos( t * 0.3 ) * r;

            light2.position.x = Math.sin( t * 0.3 +os) * r;
            light2.position.y = l2y * yr+yos;
            light2.position.z = Math.cos( t * 0.3 +os) * r;

           // light3.position.x = Math.sin( 1 * 0.03 +2*os) * r;
            light3.position.y = l3y * yr+yos;
           // light3.position.z = Math.cos( 1 * 0.03 +2*os) * r;

            // constrain light to camera movement
            var l3x=camera.position.x*0.3  +Math.sin( t * 0.3 +2*os) * 0.5*WORLDSCALE;
            var l3z=camera.position.z*0.3  +Math.cos( t * 0.1 ) * 0.5*WORLDSCALE;
            light3.position.x+=(l3x-light3.position.x)/5.0; 
            light3.position.z+=(l3z-light3.position.z)/5.0;

            cGlobalLightInt+=(tGlobalLightInt-cGlobalLightInt)/60;
            var intMult=1.0;
            if (!ACTIVATED) intMult=0.1;
            // blinking at top and bottom positions
            var l1IntOs=0,l2IntOs=0,l3IntOs=0;
            if (!resetting && ACTIVATED)
	            {if(Math.abs(l1y)>0.99) l1IntOs=2;
	            if(Math.abs(l2y)>0.99) l2IntOs=2;
	            if(Math.abs(l3y)>0.99) l3IntOs=2;
	        	}
            light1.intensity=cGlobalLightInt*l1Int*intMult+l1IntOs;
            light2.intensity=cGlobalLightInt*l2Int*intMult+l2IntOs;
            light3.intensity=cGlobalLightInt*l3Int*intMult+l3IntOs;
            
            light1.obj.material.opacity=(cGlobalLightInt*l1Int)+l1IntOs;
            light2.obj.material.opacity=(cGlobalLightInt*l2Int)+l2IntOs;
            light3.obj.material.opacity=(cGlobalLightInt*l3Int)+l3IntOs;

            var h=0;
            screenLight.intensity=  (countdown/COLLAPSETIME)*cGlobalLightInt;//Math.sin(t*0.025)/2+0.5;
           // screenLight.color.setHSL(h,0,screenLight.intensity);
	        screenObj.material.color.setHSL(h,0,cGlobalLightInt);
            /*
            if ( Math.random()<0.2)
            	{	
	            screenLight.intensity=Math.random()*1;
	            var h=Math.random();
	            screenLight.color.setHSL(h,1,screenLight.intensity);
	            screenObj.material.color.setHSL(h,1,screenLight.intensity);
	            screenObj.material.map=tex_screen[Math.round(Math.random()*2)];
           		}
           		*/

        
           	
           	var l1Dist= camera.position.distanceTo(light1.position)/WORLDSCALE /10;  //.distanceToSquared 
           	var l2Dist= camera.position.distanceTo(light2.position)/WORLDSCALE/10;  //.distanceToSquared 
	        
           	// SOUND _-----------------------------------------------


           	if (ACTIVATED && !MUTED)
           	{var globalV=Math.max(0,cGlobalLightInt);

			if (!SIMULATE)
				{


				var mult=0.3;
				 audioFrOsc1_1.setVolume( ( ((light1.position.y/yr))/9	*	(1/l1Dist	*l1Int		*globalV))*mult);
				 audioFrOsc2_1.setVolume( ( ((light2.position.y/yr))/9   *	(1/l2Dist	*l2Int		*globalV))*mult);
				 audioFrOsc3_1.setVolume( ( ((light3.position.y/yr))/9	*	(l3Int		*globalV))*mult);
				 

				 audioFrOsc1_2.setVolume( ( ((light1.position.y/yr))/4	*	(1/l1Dist	*l1Int		*globalV))*mult);
				 audioFrOsc2_2.setVolume( ( ((light2.position.y/yr))/4   *	(1/l2Dist	*l2Int		*globalV))*mult);
				 audioFrOsc3_2.setVolume( ( ((light3.position.y/yr))/4	*	(l3Int		*globalV))*mult);
			//console.log(globalV+  " "+(( ((light3.position.y/yr))/9	*	(l3Int		*globalV))*mult));
				 }
			else 
				{

				 audioOsc1_1.setVolume(1/l1Dist	*l1Int		*globalV *0.3);
				 audioOsc2_1.setVolume(1/l2Dist	*l2Int		*globalV*0.3);
				 audioOsc3_1.setVolume(l3Int		*globalV*0.3);

				 audioOsc1_2.setVolume(((light1.position.y/yr))/18	*	(1/l1Dist	*l1Int		*globalV));
				 audioOsc2_2.setVolume(((light2.position.y/yr))/18   *	(1/l2Dist	*l2Int		*globalV));
				 audioOsc3_2.setVolume(((light3.position.y/yr))/18	*	(l3Int		*globalV));
				 
				//console.log(globalV);
				 }

				 if ((l3y<-0.99) && !audioBassic1.isPlaying )
				 	{	
						audioBassic1.setVolume(0.3*globalV);
				 		audioBassic1.play();
				 	}
				 if ((l3y>0.99) && !audioBassic1_1.isPlaying )
				 	{	audioBassic1_1.setVolume(0.3*globalV);
				 		audioBassic1_1.play();
				 		
				 	}

				 if ((l1y<-0.99) && !audioBassic3.isPlaying )
				 	{	
						audioBassic3.setVolume(0.3*1/l1Dist*globalV);
				 		audioBassic3.play();
				 	}
				 if ((l1y>0.99) && !audioBassic3_1.isPlaying )
				 	{	audioBassic3_1.setVolume(0.3*1/l1Dist*globalV);
				 		audioBassic3_1.play();
				 		
				 	}
				 if ((l2y<-0.99) && !audioBassic2.isPlaying )
				 	{	
						audioBassic2.setVolume(0.3*1/l2Dist*globalV);
				 		audioBassic2.play();
				 	}
				 if ((l2y>0.99) && !audioBassic2_1.isPlaying )
				 	{	audioBassic2_1.setVolume(0.3*1/l2Dist*globalV);
				 		audioBassic2_1.play();
				 		
				 	}

				if (SIMULATE)
				{
				audioKling.setVolume((1-(countdown/COLLAPSETIME))*0.3);
				audioBgloop.setVolume((countdown/COLLAPSETIME)*0.2);

				}
				else
				{audioKling.setVolume(0);
				audioBgloop.setVolume(0);

				}

			}
				//osc1.mul=	1/l1Dist	*l1Int		*cGlobalLightInt;
				//osc2.mul=	1/l2Dist	*l2Int		*cGlobalLightInt;
				//osc3.mul=				l3Int		*cGlobalLightInt;


        }

    function freezeSimulation(freeze)
      { ACTIVATED=true;
      	SIMULATE=!freeze;
      	if (!MUTED)
      	{
      	if (!SIMULATE)
				{audioFreezeloop.setVolume(0.2);
				 audioBgloop.setVolume(0);
				 audioRainrumba.setVolume(0.2);
				 audioRumba.setVolume(0);
				 audioOsc1_1.stop();
				 audioOsc1_2.stop();
				 audioOsc2_1.stop();
				 audioOsc2_2.stop();
				 audioOsc3_1.stop();
				 audioOsc3_2.stop();
			    if( !audioFrOsc1_1.isPlaying) audioFrOsc1_1.play();
				if( !audioFrOsc1_2.isPlaying)  audioFrOsc1_2.play();
				if( !audioFrOsc2_1.isPlaying) audioFrOsc2_1.play();
				if( !audioFrOsc2_2.isPlaying)  audioFrOsc2_2.play();
				if( !audioFrOsc3_1.isPlaying) audioFrOsc3_1.play();
				if( !audioFrOsc3_2.isPlaying)  audioFrOsc3_2.play();
				
				 }
			else
				{audioFreezeloop.setVolume(0);
				 //audioBgloop.setVolume(0.2);
				 audioRainrumba.setVolume(0);
				 audioRumba.setVolume(0.35);
				if( !audioOsc1_1.isPlaying)  audioOsc1_1.play();
				if( !audioOsc1_2.isPlaying)  audioOsc1_2.play();
				if( !audioOsc2_1.isPlaying)  audioOsc2_1.play();
				if( !audioOsc2_2.isPlaying)  audioOsc2_2.play();
				if( !audioOsc3_1.isPlaying)  audioOsc3_1.play();
				if( !audioOsc3_2.isPlaying)  audioOsc3_2.play();
				if (audioFrOsc1_1.isPlaying) audioFrOsc1_1.stop();
				if (audioFrOsc1_2.isPlaying)  audioFrOsc1_2.stop();
				if (audioFrOsc2_1.isPlaying)  audioFrOsc2_1.stop();
				if (audioFrOsc2_2.isPlaying)  audioFrOsc2_2.stop();
				if (audioFrOsc3_1.isPlaying)  audioFrOsc3_1.stop();
				if (audioFrOsc3_2.isPlaying)  audioFrOsc3_2.stop();

				//scene_physi.onSimulationResume();

			
				 }
			}

      }
	
		

    window.onload = manageLoading;
	


        </script>
	  }

    </body>
</html>
